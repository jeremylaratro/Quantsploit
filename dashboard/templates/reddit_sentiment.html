{% extends "base.html" %}

{% block title %}Reddit Sentiment Analysis - Quantsploit{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-4 fw-bold text-center mb-4">
            <i class="fab fa-reddit"></i> Reddit Sentiment Analysis Dashboard
        </h1>
        <p class="text-center text-muted">Real-time social media sentiment tracking for stock tickers</p>
    </div>
</div>

<!-- Control Panel -->
<div class="card mb-4">
    <div class="card-header bg-gradient-primary text-white">
        <h5 class="mb-0"><i class="fas fa-sliders-h"></i> Analysis Settings</h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Subreddits</label>
                <input type="text" class="form-control" id="subreddits"
                       value="wallstreetbets,stocks,investing,StockMarket,options"
                       placeholder="Comma-separated subreddits">
            </div>
            <div class="col-md-3">
                <label class="form-label">Time Filter</label>
                <select class="form-select" id="timeFilter">
                    <option value="hour">Past Hour</option>
                    <option value="day" selected>Past Day</option>
                    <option value="week">Past Week</option>
                    <option value="month">Past Month</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Post Limit</label>
                <input type="number" class="form-control" id="postLimit" value="100" min="10" max="500">
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-primary w-100" onclick="analyzeSentiment()">
                    <i class="fas fa-play"></i> Run Analysis
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="text-center my-5" style="display: none;">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Analyzing Reddit sentiment...</p>
</div>

<!-- Results Container -->
<div id="resultsContainer" style="display: none;">

    <!-- Summary Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card blue">
                <i class="fas fa-comments fa-2x mb-2"></i>
                <div class="stat-label">Posts Analyzed</div>
                <div class="stat-value" id="totalPosts">0</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card green">
                <i class="fas fa-chart-line fa-2x mb-2"></i>
                <div class="stat-label">Tickers Found</div>
                <div class="stat-value" id="tickersFound">0</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card orange">
                <i class="fas fa-fire fa-2x mb-2"></i>
                <div class="stat-label">Top Sentiment</div>
                <div class="stat-value" id="topSentiment">-</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" id="signalCard">
                <i class="fas fa-bullseye fa-2x mb-2"></i>
                <div class="stat-label">Buy Signals</div>
                <div class="stat-value" id="buySignals">0</div>
            </div>
        </div>
    </div>

    <!-- Top Tickers Table and Chart -->
    <div class="row mb-4">
        <div class="col-lg-7">
            <div class="card">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-trophy"></i> Top 10 Most Mentioned Tickers</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="topTickersTable">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Ticker</th>
                                    <th>Mentions</th>
                                    <th>Sentiment</th>
                                    <th>Category</th>
                                    <th>Signal</th>
                                    <th>Strength</th>
                                </tr>
                            </thead>
                            <tbody id="topTickersBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="card">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Sentiment Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="sentimentPieChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Sentiment vs Mentions Scatter Plot -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-scatter"></i> Sentiment vs Mention Volume</h5>
                </div>
                <div class="card-body">
                    <canvas id="sentimentScatterChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Posts for Selected Ticker -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-comments"></i> Top Reddit Posts</h5>
                    <select class="form-select form-select-sm" id="tickerSelector" style="max-width: 200px;" onchange="updateTopPosts()">
                    </select>
                </div>
                <div class="card-body">
                    <div id="topPostsContainer">
                        <p class="text-muted">Select a ticker to view top posts</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trading Signals -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-signal"></i> Trading Signals</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="signalsTable">
                            <thead>
                                <tr>
                                    <th>Ticker</th>
                                    <th>Signal</th>
                                    <th>Confidence</th>
                                    <th>Sentiment Score</th>
                                    <th>Mentions</th>
                                    <th>Reasons</th>
                                </tr>
                            </thead>
                            <tbody id="signalsBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let sentimentData = null;
let sentimentPieChart = null;
let sentimentScatterChart = null;

function analyzeSentiment() {
    const subreddits = document.getElementById('subreddits').value;
    const timeFilter = document.getElementById('timeFilter').value;
    const postLimit = document.getElementById('postLimit').value;

    // Show loading spinner
    document.getElementById('loadingSpinner').style.display = 'block';
    document.getElementById('resultsContainer').style.display = 'none';

    // Make API call
    fetch(`/api/reddit-sentiment?subreddits=${encodeURIComponent(subreddits)}&time_filter=${timeFilter}&post_limit=${postLimit}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                sentimentData = data;
                displayResults(data);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to fetch sentiment data: ' + error);
        })
        .finally(() => {
            document.getElementById('loadingSpinner').style.display = 'none';
        });
}

function displayResults(data) {
    // Show results container
    document.getElementById('resultsContainer').style.display = 'block';

    // Update summary stats
    document.getElementById('totalPosts').textContent = data.total_posts.toLocaleString();
    document.getElementById('tickersFound').textContent = data.tickers_found;

    if (data.top_10_tickers.length > 0) {
        const topTicker = data.top_10_tickers[0];
        document.getElementById('topSentiment').textContent = topTicker.ticker;
    }

    // Count buy signals
    const buySignals = data.results.filter(r => r.avg_sentiment > 0.3).length;
    document.getElementById('buySignals').textContent = buySignals;

    // Update top tickers table
    updateTopTickersTable(data.top_10_tickers);

    // Update sentiment charts
    updateSentimentCharts(data.top_10_tickers);

    // Populate ticker selector
    const tickerSelector = document.getElementById('tickerSelector');
    tickerSelector.innerHTML = '<option value="">-- Select Ticker --</option>';
    data.top_10_tickers.forEach(ticker => {
        const option = document.createElement('option');
        option.value = ticker.ticker;
        option.textContent = `${ticker.ticker} (${ticker.mentions} mentions)`;
        tickerSelector.appendChild(option);
    });

    // Update signals table (using simple heuristic)
    updateSignalsTable(data.results);
}

function updateTopTickersTable(tickers) {
    const tbody = document.getElementById('topTickersBody');
    tbody.innerHTML = '';

    tickers.forEach((ticker, index) => {
        const row = document.createElement('tr');

        const sentimentClass = ticker.avg_sentiment >= 0.05 ? 'text-success' :
                              ticker.avg_sentiment <= -0.05 ? 'text-danger' : 'text-warning';

        const signal = ticker.avg_sentiment > 0.3 ? 'ðŸŸ¢ BUY' :
                      ticker.avg_sentiment > 0.1 ? 'ðŸŸ¡ HOLD' : 'ðŸ”´ AVOID';

        row.innerHTML = `
            <td><strong>#${index + 1}</strong></td>
            <td><strong>${ticker.ticker}</strong></td>
            <td>${ticker.mentions}</td>
            <td class="${sentimentClass}"><strong>${ticker.avg_sentiment.toFixed(3)}</strong></td>
            <td><span class="badge bg-secondary">${ticker.sentiment_category}</span></td>
            <td>${signal}</td>
            <td>${ticker.sentiment_strength.toFixed(2)}</td>
        `;
        tbody.appendChild(row);
    });
}

function updateSentimentCharts(tickers) {
    // Sentiment Pie Chart
    const sentimentCategories = {};
    tickers.forEach(ticker => {
        const category = ticker.sentiment_category;
        sentimentCategories[category] = (sentimentCategories[category] || 0) + 1;
    });

    const pieCtx = document.getElementById('sentimentPieChart').getContext('2d');
    if (sentimentPieChart) {
        sentimentPieChart.destroy();
    }

    sentimentPieChart = new Chart(pieCtx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(sentimentCategories),
            datasets: [{
                data: Object.values(sentimentCategories),
                backgroundColor: [
                    '#27ae60', '#2ecc71', '#a8e6cf',
                    '#95a5a6',
                    '#ffd3b6', '#e74c3c', '#c0392b'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Sentiment vs Mentions Scatter Plot
    const scatterCtx = document.getElementById('sentimentScatterChart').getContext('2d');
    if (sentimentScatterChart) {
        sentimentScatterChart.destroy();
    }

    const scatterData = tickers.map(ticker => ({
        x: ticker.mentions,
        y: ticker.avg_sentiment,
        label: ticker.ticker
    }));

    sentimentScatterChart = new Chart(scatterCtx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Tickers',
                data: scatterData,
                backgroundColor: scatterData.map(d =>
                    d.y >= 0.3 ? 'rgba(39, 174, 96, 0.6)' :
                    d.y >= 0 ? 'rgba(241, 196, 15, 0.6)' :
                    'rgba(231, 76, 60, 0.6)'
                ),
                borderColor: scatterData.map(d =>
                    d.y >= 0.3 ? 'rgba(39, 174, 96, 1)' :
                    d.y >= 0 ? 'rgba(241, 196, 15, 1)' :
                    'rgba(231, 76, 60, 1)'
                ),
                pointRadius: 8,
                pointHoverRadius: 12
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const point = scatterData[context.dataIndex];
                            return `${point.label}: ${point.x} mentions, sentiment ${point.y.toFixed(3)}`;
                        }
                    }
                },
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Number of Mentions'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Sentiment Score'
                    }
                }
            }
        }
    });
}

function updateTopPosts() {
    const selectedTicker = document.getElementById('tickerSelector').value;
    const container = document.getElementById('topPostsContainer');

    if (!selectedTicker || !sentimentData) {
        container.innerHTML = '<p class="text-muted">Select a ticker to view top posts</p>';
        return;
    }

    const tickerData = sentimentData.results.find(r => r.ticker === selectedTicker);
    if (!tickerData || !tickerData.top_posts || tickerData.top_posts.length === 0) {
        container.innerHTML = '<p class="text-muted">No posts found for this ticker</p>';
        return;
    }

    let html = '<div class="list-group">';
    tickerData.top_posts.forEach(post => {
        const sentimentBadge = post.sentiment >= 0.05 ? 'bg-success' :
                               post.sentiment <= -0.05 ? 'bg-danger' : 'bg-warning';

        html += `
            <a href="${post.url}" target="_blank" class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${post.title}</h6>
                    <small>
                        <span class="badge ${sentimentBadge}">Sentiment: ${post.sentiment.toFixed(3)}</span>
                    </small>
                </div>
                <div class="d-flex w-100 justify-content-between">
                    <small class="text-muted">r/${post.subreddit} â€¢ ${post.created}</small>
                    <small><i class="fas fa-arrow-up"></i> ${post.score}</small>
                </div>
            </a>
        `;
    });
    html += '</div>';

    container.innerHTML = html;
}

function updateSignalsTable(results) {
    const tbody = document.getElementById('signalsBody');
    tbody.innerHTML = '';

    // Generate simple trading signals
    const signals = results
        .filter(r => Math.abs(r.avg_sentiment) > 0.1 || r.mentions > 20)
        .slice(0, 20);

    signals.forEach(ticker => {
        const row = document.createElement('tr');

        let signal, confidence, signalClass;
        const sentiment = ticker.avg_sentiment;
        const negativeRatio = ticker.negative_mentions / ticker.mentions;

        if (sentiment > 0.3 && ticker.avg_post_score > 20 && negativeRatio < 0.3) {
            signal = 'ðŸŸ¢ BUY';
            confidence = sentiment > 0.5 ? 'HIGH' : 'MEDIUM';
            signalClass = 'table-success';
        } else if (sentiment > 0.1) {
            signal = 'ðŸŸ¡ HOLD';
            confidence = 'LOW';
            signalClass = 'table-warning';
        } else {
            signal = 'ðŸ”´ SELL/AVOID';
            confidence = sentiment < -0.3 ? 'HIGH' : 'MEDIUM';
            signalClass = 'table-danger';
        }

        const reasons = [];
        if (sentiment > 0.3) reasons.push('Bullish sentiment');
        if (ticker.mentions > 50) reasons.push(`High volume (${ticker.mentions})`);
        if (ticker.avg_post_score > 100) reasons.push('Quality posts');
        if (negativeRatio < 0.1) reasons.push('Low negativity');
        if (sentiment < 0) reasons.push('Negative sentiment');

        row.className = signalClass;
        row.innerHTML = `
            <td><strong>${ticker.ticker}</strong></td>
            <td>${signal}</td>
            <td><span class="badge bg-secondary">${confidence}</span></td>
            <td>${sentiment.toFixed(3)}</td>
            <td>${ticker.mentions}</td>
            <td><small>${reasons.join(', ') || 'N/A'}</small></td>
        `;
        tbody.appendChild(row);
    });
}

// Auto-run on page load with default settings
window.onload = function() {
    // Optionally auto-run analysis
    // analyzeSentiment();
};
</script>
{% endblock %}
