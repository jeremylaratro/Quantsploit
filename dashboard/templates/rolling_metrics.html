{% extends "base.html" %}

{% block title %}Rolling Metrics - Quantsploit{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4">
                <i class="fas fa-chart-line"></i> Rolling Performance Metrics
            </h1>
            <p class="lead">Time-series analysis with rolling windows for trend identification</p>
            <small class="text-muted">Run: {{ timestamp }}</small>
        </div>
    </div>

    <!-- Window Configuration -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-sliders"></i> Rolling Window Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">Rolling Window Size (periods)</label>
                            <input type="range" class="form-range" id="window-size" min="2" max="6" value="3">
                            <div class="text-center"><span id="window-display">3</span> periods</div>
                        </div>
                        <div class="col-md-8">
                            <button class="btn btn-primary" onclick="loadRollingMetrics()">
                                <i class="fas fa-refresh"></i> Recalculate
                            </button>
                            <small class="text-muted ms-3">
                                <i class="fas fa-info-circle"></i>
                                Rolling window shows performance trends across consecutive time periods
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card blue">
                <div class="stat-label">Total Rolling Windows</div>
                <div class="stat-value" id="total-windows">--</div>
                <small>Across all strategies</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card green">
                <div class="stat-label">Best Rolling Return</div>
                <div class="stat-value" id="best-rolling-return">--</div>
                <small id="best-rolling-strategy">--</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card orange">
                <div class="stat-label">Most Consistent</div>
                <div class="stat-value" id="most-consistent">--</div>
                <small>Lowest volatility</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-label">Best Rolling Sharpe</div>
                <div class="stat-value" id="best-rolling-sharpe">--</div>
                <small id="best-sharpe-strategy">--</small>
            </div>
        </div>
    </div>

    <!-- Rolling Performance Charts -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> Rolling Returns by Strategy</h5>
                </div>
                <div class="card-body">
                    <canvas id="rolling-returns-chart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-wave-square"></i> Rolling Sharpe Ratio</h5>
                </div>
                <div class="card-body">
                    <canvas id="rolling-sharpe-chart" height="250"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-area"></i> Consistency Trends</h5>
                </div>
                <div class="card-body">
                    <canvas id="consistency-chart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Table -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-table"></i> Rolling Window Details</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped table-sm" id="rolling-table">
                            <thead>
                                <tr>
                                    <th>Strategy</th>
                                    <th>Window</th>
                                    <th>Periods</th>
                                    <th>Avg Return</th>
                                    <th>Avg Sharpe</th>
                                    <th>Consistency</th>
                                    <th>Win Rate</th>
                                </tr>
                            </thead>
                            <tbody id="rolling-tbody">
                                <tr><td colspan="7" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
let currentData = null;

// Update window size display
document.getElementById('window-size').addEventListener('input', function() {
    document.getElementById('window-display').textContent = this.value;
});

async function loadRollingMetrics() {
    const windowSize = document.getElementById('window-size').value;

    try {
        const response = await fetch(`/api/rolling-metrics/{{ timestamp }}?window=${windowSize}`);
        const data = await response.json();

        currentData = data;

        if (data.rolling_metrics && data.rolling_metrics.length > 0) {
            // Update summary stats
            updateSummaryStats(data.rolling_metrics);

            // Create charts
            createRollingReturnsChart(data.rolling_metrics);
            createRollingSharpeChart(data.rolling_metrics);
            createConsistencyChart(data.rolling_metrics);

            // Populate table
            populateRollingTable(data.rolling_metrics);
        } else {
            document.getElementById('rolling-tbody').innerHTML = '<tr><td colspan="7" class="text-center text-warning">Not enough data for rolling analysis with this window size</td></tr>';
        }

    } catch (error) {
        console.error('Error loading rolling metrics:', error);
    }
}

function updateSummaryStats(metrics) {
    document.getElementById('total-windows').textContent = metrics.length.toLocaleString();

    // Find best rolling return
    const bestReturn = metrics.reduce((max, m) => m.avg_return > max.avg_return ? m : max);
    document.getElementById('best-rolling-return').textContent = (bestReturn.avg_return * 100).toFixed(2) + '%';
    document.getElementById('best-rolling-strategy').textContent = bestReturn.strategy;

    // Find most consistent (lowest consistency value = lowest std dev)
    const mostConsistent = metrics.reduce((min, m) => m.consistency < min.consistency ? m : min);
    document.getElementById('most-consistent').textContent = mostConsistent.strategy;

    // Find best Sharpe
    const bestSharpe = metrics.reduce((max, m) => m.avg_sharpe > max.avg_sharpe ? m : max);
    document.getElementById('best-rolling-sharpe').textContent = bestSharpe.avg_sharpe.toFixed(2);
    document.getElementById('best-sharpe-strategy').textContent = bestSharpe.strategy;
}

function createRollingReturnsChart(metrics) {
    const ctx = document.getElementById('rolling-returns-chart').getContext('2d');

    // Group by strategy
    const strategyData = {};
    metrics.forEach(m => {
        if (!strategyData[m.strategy]) {
            strategyData[m.strategy] = [];
        }
        strategyData[m.strategy].push({
            window: m.window,
            return: m.avg_return * 100
        });
    });

    // Create datasets for each strategy
    const datasets = Object.keys(strategyData).slice(0, 10).map((strategy, index) => {
        const colors = [
            'rgb(255, 99, 132)',
            'rgb(54, 162, 235)',
            'rgb(255, 206, 86)',
            'rgb(75, 192, 192)',
            'rgb(153, 102, 255)',
            'rgb(255, 159, 64)',
            'rgb(199, 199, 199)',
            'rgb(83, 102, 255)',
            'rgb(255, 99, 255)',
            'rgb(99, 255, 132)'
        ];

        return {
            label: strategy,
            data: strategyData[strategy].map(d => d.return),
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length].replace('rgb', 'rgba').replace(')', ', 0.1)'),
            tension: 0.4,
            fill: false
        };
    });

    const labels = strategyData[Object.keys(strategyData)[0]].map(d => d.window);

    if (window.rollingReturnsChart) {
        window.rollingReturnsChart.destroy();
    }

    window.rollingReturnsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    title: { display: true, text: 'Return (%)' }
                },
                x: {
                    ticks: { maxRotation: 45, minRotation: 45 }
                }
            },
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
}

function createRollingSharpeChart(metrics) {
    const ctx = document.getElementById('rolling-sharpe-chart').getContext('2d');

    // Group by strategy
    const strategyData = {};
    metrics.forEach(m => {
        if (!strategyData[m.strategy]) {
            strategyData[m.strategy] = [];
        }
        strategyData[m.strategy].push({
            window: m.window,
            sharpe: m.avg_sharpe
        });
    });

    const datasets = Object.keys(strategyData).slice(0, 5).map((strategy, index) => {
        const colors = ['rgb(255, 99, 132)', 'rgb(54, 162, 235)', 'rgb(255, 206, 86)', 'rgb(75, 192, 192)', 'rgb(153, 102, 255)'];

        return {
            label: strategy,
            data: strategyData[strategy].map(d => d.sharpe),
            borderColor: colors[index],
            tension: 0.4,
            fill: false
        };
    });

    const labels = strategyData[Object.keys(strategyData)[0]].map(d => d.window);

    if (window.rollingSharpeChart) {
        window.rollingSharpeChart.destroy();
    }

    window.rollingSharpeChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    title: { display: true, text: 'Sharpe Ratio' }
                },
                x: {
                    ticks: { maxRotation: 45, minRotation: 45 }
                }
            }
        }
    });
}

function createConsistencyChart(metrics) {
    const ctx = document.getElementById('consistency-chart').getContext('2d');

    // Group by strategy and calculate average consistency
    const strategyConsistency = {};
    metrics.forEach(m => {
        if (!strategyConsistency[m.strategy]) {
            strategyConsistency[m.strategy] = [];
        }
        strategyConsistency[m.strategy].push(m.consistency);
    });

    const avgConsistency = Object.keys(strategyConsistency).map(strategy => ({
        strategy: strategy,
        consistency: strategyConsistency[strategy].reduce((a, b) => a + b, 0) / strategyConsistency[strategy].length
    })).sort((a, b) => a.consistency - b.consistency).slice(0, 10);

    if (window.consistencyChart) {
        window.consistencyChart.destroy();
    }

    window.consistencyChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: avgConsistency.map(s => s.strategy),
            datasets: [{
                label: 'Consistency (lower is better)',
                data: avgConsistency.map(s => s.consistency * 100),
                backgroundColor: 'rgba(75, 192, 192, 0.7)'
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: { display: true, text: 'Std Deviation (%)' }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
}

function populateRollingTable(metrics) {
    const tbody = document.getElementById('rolling-tbody');
    tbody.innerHTML = '';

    // Sort by avg return
    const sorted = [...metrics].sort((a, b) => b.avg_return - a.avg_return);

    sorted.forEach(metric => {
        const row = tbody.insertRow();

        row.innerHTML = `
            <td><strong>${metric.strategy}</strong></td>
            <td>${metric.window}</td>
            <td><small>${metric.periods.join(', ')}</small></td>
            <td class="${metric.avg_return > 0 ? 'text-success' : 'text-danger'}">${(metric.avg_return * 100).toFixed(2)}%</td>
            <td>${metric.avg_sharpe.toFixed(2)}</td>
            <td>${(metric.consistency * 100).toFixed(2)}%</td>
            <td>${metric.win_rate.toFixed(1)}%</td>
        `;

        // Highlight excellent performers
        if (metric.avg_sharpe > 2.0) {
            row.style.backgroundColor = '#e8f5e9';
        }
    });
}

// Load data on page load
document.addEventListener('DOMContentLoaded', loadRollingMetrics);
</script>
{% endblock %}
