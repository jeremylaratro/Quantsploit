{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-4 fw-bold text-center mb-4">
            <i class="fas fa-rocket"></i> Backtest Launcher
        </h1>
        <p class="text-center text-muted">Configure and launch comprehensive strategy backtests</p>
    </div>
</div>

<!-- Backtest Configuration Form -->
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow-lg border-0">
            <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h4 class="mb-0"><i class="fas fa-cog"></i> Configuration</h4>
            </div>
            <div class="card-body p-4">
                <form id="backtestForm">
                    <!-- Symbol Selection -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-chart-line"></i> Symbol Selection
                        </label>
                        <div class="btn-group w-100 mb-3" role="group">
                            <input type="radio" class="btn-check" name="symbolMode" id="presetMode" value="preset" checked>
                            <label class="btn btn-outline-primary" for="presetMode">Preset Lists</label>

                            <input type="radio" class="btn-check" name="symbolMode" id="customMode" value="custom">
                            <label class="btn btn-outline-primary" for="customMode">Custom Symbols</label>
                        </div>

                        <!-- Preset Lists -->
                        <div id="presetSymbols">
                            <select class="form-select" id="presetList">
                                <option value="AAPL,MSFT,GOOGL,TSLA,SPY">Quick Test (5 symbols)</option>
                                <option value="AAPL,MSFT,GOOGL,AMZN,TSLA,META,NVDA,NFLX,AMD,INTC">Top Tech (10 symbols)</option>
                                <option value="SPY,QQQ,IWM,DIA,VTI">Market ETFs (5 symbols)</option>
                            </select>
                        </div>

                        <!-- Custom Symbols -->
                        <div id="customSymbols" style="display: none;">
                            <input type="text" class="form-control" id="customSymbolInput"
                                   placeholder="Enter symbols separated by commas (e.g., AAPL,MSFT,GOOGL)">
                            <small class="form-text text-muted">Enter comma-separated ticker symbols</small>
                        </div>
                    </div>

                    <!-- Time Period Selection -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-calendar-alt"></i> Time Period Configuration
                        </label>
                        <div class="btn-group w-100 mb-3" role="group">
                            <input type="radio" class="btn-check" name="periodMode" id="defaultPeriod" value="default" checked>
                            <label class="btn btn-outline-primary" for="defaultPeriod">Default Periods</label>

                            <input type="radio" class="btn-check" name="periodMode" id="customPeriod" value="custom">
                            <label class="btn btn-outline-primary" for="customPeriod">Custom Periods</label>

                            <input type="radio" class="btn-check" name="periodMode" id="quarterlyPeriod" value="quarterly">
                            <label class="btn btn-outline-primary" for="quarterlyPeriod">Quarterly</label>
                        </div>

                        <!-- Custom Period Configuration -->
                        <div id="customPeriodConfig" style="display: none;">
                            <div class="row">
                                <div class="col-md-4 mb-2">
                                    <label class="form-label">Total Span</label>
                                    <input type="text" class="form-control" id="tspan" placeholder="e.g., 2y, 18m">
                                </div>
                                <div class="col-md-4 mb-2">
                                    <label class="form-label">Period Span</label>
                                    <input type="text" class="form-control" id="bspan" placeholder="e.g., 6m, 180d">
                                </div>
                                <div class="col-md-4 mb-2">
                                    <label class="form-label">Num Periods</label>
                                    <input type="number" class="form-control" id="numPeriods" placeholder="e.g., 4">
                                </div>
                            </div>
                        </div>

                        <!-- Quarterly Configuration -->
                        <div id="quarterlyConfig" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <label class="form-label">Quarter(s)</label>
                                    <input type="text" class="form-control" id="quarters" placeholder="e.g., 1 or 1,2,3">
                                    <small class="form-text text-muted">Single quarter or comma-separated list</small>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label class="form-label">Number of Occurrences (optional)</label>
                                    <input type="number" class="form-control" id="quarterPeriods" placeholder="e.g., 4">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Trading Parameters -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-dollar-sign"></i> Trading Parameters
                        </label>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Initial Capital</label>
                                <input type="number" class="form-control" id="capital" value="100000" step="1000">
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Commission (%)</label>
                                <input type="number" class="form-control" id="commission" value="0.1" step="0.01">
                            </div>
                        </div>
                    </div>

                    <!-- Launch Button -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <i class="fas fa-play"></i> Launch Backtest
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Status Panel -->
        <div class="card shadow-lg border-0 mt-4" id="statusPanel" style="display: none;">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Backtest Status</h5>
            </div>
            <div class="card-body">
                <div id="statusMessage" class="mb-3"></div>
                <div class="progress" id="progressBar" style="display: none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Toggle between preset and custom symbols
document.querySelectorAll('input[name="symbolMode"]').forEach(radio => {
    radio.addEventListener('change', function() {
        if (this.value === 'preset') {
            document.getElementById('presetSymbols').style.display = 'block';
            document.getElementById('customSymbols').style.display = 'none';
        } else {
            document.getElementById('presetSymbols').style.display = 'none';
            document.getElementById('customSymbols').style.display = 'block';
        }
    });
});

// Toggle between period modes
document.querySelectorAll('input[name="periodMode"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.getElementById('customPeriodConfig').style.display = 'none';
        document.getElementById('quarterlyConfig').style.display = 'none';

        if (this.value === 'custom') {
            document.getElementById('customPeriodConfig').style.display = 'block';
        } else if (this.value === 'quarterly') {
            document.getElementById('quarterlyConfig').style.display = 'block';
        }
    });
});

// Form submission
document.getElementById('backtestForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    // Gather form data
    const symbolMode = document.querySelector('input[name="symbolMode"]:checked').value;
    const symbols = symbolMode === 'preset'
        ? document.getElementById('presetList').value
        : document.getElementById('customSymbolInput').value.trim();

    if (!symbols) {
        alert('Please specify symbols to backtest');
        return;
    }

    const periodMode = document.querySelector('input[name="periodMode"]:checked').value;
    const capital = document.getElementById('capital').value;
    const commission = parseFloat(document.getElementById('commission').value) / 100;

    // Build request payload
    const payload = {
        symbols: symbols,
        capital: parseFloat(capital),
        commission: commission,
        period_mode: periodMode
    };

    // Add period-specific parameters
    if (periodMode === 'custom') {
        payload.tspan = document.getElementById('tspan').value.trim();
        payload.bspan = document.getElementById('bspan').value.trim();
        payload.num_periods = parseInt(document.getElementById('numPeriods').value);

        if (!payload.tspan || !payload.bspan || !payload.num_periods) {
            alert('Please fill in all custom period fields');
            return;
        }
    } else if (periodMode === 'quarterly') {
        payload.quarters = document.getElementById('quarters').value.trim();
        const quarterPeriods = document.getElementById('quarterPeriods').value;
        if (quarterPeriods) {
            payload.quarter_periods = parseInt(quarterPeriods);
        }

        if (!payload.quarters) {
            alert('Please specify quarter(s) to backtest');
            return;
        }
    }

    // Show status panel
    const statusPanel = document.getElementById('statusPanel');
    const statusMessage = document.getElementById('statusMessage');
    const progressBar = document.getElementById('progressBar');

    statusPanel.style.display = 'block';
    progressBar.style.display = 'block';
    statusMessage.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Launching backtest...';

    try {
        const response = await fetch('/api/launch-backtest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (response.ok) {
            progressBar.style.display = 'none';
            statusMessage.innerHTML = \`
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> <strong>Backtest launched successfully!</strong><br>
                    <small>The backtest is running in the background. Results will appear in the dashboard when complete.</small><br>
                    <small>Command: <code>\${result.command}</code></small>
                    <div class="mt-2">
                        <a href="/" class="btn btn-sm btn-primary">Go to Dashboard</a>
                    </div>
                </div>
            \`;
        } else {
            progressBar.style.display = 'none';
            statusMessage.innerHTML = \`
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i> <strong>Error:</strong> \${result.error || 'Failed to launch backtest'}
                </div>
            \`;
        }
    } catch (error) {
        progressBar.style.display = 'none';
        statusMessage.innerHTML = \`
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i> <strong>Error:</strong> \${error.message}
            </div>
        \`;
    }
});
</script>
{% endblock %}
