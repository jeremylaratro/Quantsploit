{% extends "base.html" %}

{% block title %}Ticker Explorer - Quantsploit{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4">
                <i class="fas fa-search"></i> Ticker Explorer
            </h1>
            <p class="lead">Advanced filtering and universe management - S&P 500, NASDAQ 100, sector breakdowns</p>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-filter"></i> Advanced Filters</h5>
                </div>
                <div class="card-body">
                    <!-- Row 1: Run Selection & Key Filters -->
                    <div class="row g-3 mb-3">
                        <!-- Backtest Run Selector -->
                        <div class="col-md-4">
                            <label class="form-label"><strong>Backtest Run</strong></label>
                            <select class="form-select" id="run-selector" onchange="loadRunData()">
                                <!-- Will be populated dynamically -->
                            </select>
                            <small class="text-muted">Select which backtest results to view</small>
                        </div>

                        <!-- Specific Ticker Filter -->
                        <div class="col-md-4">
                            <label class="form-label"><strong>Specific Tickers</strong></label>
                            <input type="text" class="form-control" id="ticker-filter" placeholder="e.g. SPY, AAPL, MSFT">
                            <small class="text-muted">Comma-separated tickers (leave empty for all)</small>
                        </div>

                        <!-- Strategy Filter -->
                        <div class="col-md-4">
                            <label class="form-label"><strong>Strategy</strong></label>
                            <select class="form-select" id="strategy-filter">
                                <option value="">All Strategies</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                    </div>

                    <!-- Row 2: Time Period & Universe -->
                    <div class="row g-3 mb-3">
                        <!-- Time Period Filter -->
                        <div class="col-md-4">
                            <label class="form-label">Time Period</label>
                            <select class="form-select" id="period-filter">
                                <option value="">All Periods</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>

                        <!-- Universe Selection -->
                        <div class="col-md-4">
                            <label class="form-label">Ticker Universe</label>
                            <select class="form-select" id="universe-filter">
                                <option value="">All Tickers</option>
                                {% for display, key in universes.items() %}
                                <option value="{{ key }}">{{ display }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Sector Filter -->
                        <div class="col-md-4">
                            <label class="form-label">Sector</label>
                            <select class="form-select" id="sector-filter">
                                <option value="">All Sectors</option>
                                {% for sector in sectors %}
                                <option value="{{ sector }}">{{ sector }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Row 3: Performance Filters -->
                    <div class="row g-3">
                        <!-- Min Return Filter -->
                        <div class="col-md-3">
                            <label class="form-label">Min Return (%)</label>
                            <input type="number" class="form-control" id="min-return" placeholder="e.g. 10" step="1">
                        </div>

                        <!-- Min Sharpe Filter -->
                        <div class="col-md-3">
                            <label class="form-label">Min Sharpe Ratio</label>
                            <input type="number" class="form-control" id="min-sharpe" placeholder="e.g. 1.0" step="0.1">
                        </div>

                        <!-- Min Win Rate Filter -->
                        <div class="col-md-3">
                            <label class="form-label">Min Win Rate (%)</label>
                            <input type="number" class="form-control" id="min-winrate" placeholder="e.g. 50" step="1">
                        </div>

                        <!-- Action Buttons -->
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-primary me-2 w-100" onclick="applyFilters()">
                                <i class="fas fa-filter"></i> Apply
                            </button>
                            <button class="btn btn-secondary w-100" onclick="resetFilters()">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Summary -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="stat-card blue">
                <div class="stat-label">Results Found</div>
                <div class="stat-value" id="results-count">--</div>
                <small>Matching your criteria</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card green">
                <div class="stat-label">Avg Return</div>
                <div class="stat-value" id="avg-return">--</div>
                <small>Of filtered results</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card orange">
                <div class="stat-label">Avg Sharpe</div>
                <div class="stat-value" id="avg-sharpe">--</div>
                <small>Risk-adjusted performance</small>
            </div>
        </div>
    </div>

    <!-- Quick Universe Buttons -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-bolt"></i> Quick Select Universe</h5>
                </div>
                <div class="card-body">
                    <div class="btn-group flex-wrap" role="group">
                        <button class="btn btn-outline-primary" onclick="selectUniverse('sp500')">
                            <i class="fas fa-chart-line"></i> S&P 500
                        </button>
                        <button class="btn btn-outline-info" onclick="selectUniverse('nasdaq100')">
                            <i class="fas fa-microchip"></i> NASDAQ 100
                        </button>
                        <button class="btn btn-outline-success" onclick="selectUniverse('russell2000')">
                            <i class="fas fa-building"></i> Russell 2000
                        </button>
                        <button class="btn btn-outline-warning" onclick="selectUniverse('mega_cap')">
                            <i class="fas fa-star"></i> Mega Cap
                        </button>
                        <button class="btn btn-outline-danger" onclick="selectUniverse('tech')">
                            <i class="fas fa-laptop"></i> Technology
                        </button>
                        <button class="btn btn-outline-secondary" onclick="selectUniverse('healthcare')">
                            <i class="fas fa-heartbeat"></i> Healthcare
                        </button>
                        <button class="btn btn-outline-dark" onclick="selectUniverse('financials')">
                            <i class="fas fa-dollar-sign"></i> Financials
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Table -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-table"></i> Filtered Results</h5>
                    <small class="text-muted">Top 100 results sorted by return</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped table-sm" id="results-table">
                            <thead>
                                <tr>
                                    <th class="sortable" onclick="sortTable('strategy_name')">
                                        Strategy <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" onclick="sortTable('symbol')">
                                        Symbol <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" onclick="sortTable('sector')">
                                        Sector <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" onclick="sortTable('period_name')">
                                        Period <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" onclick="sortTable('total_return')">
                                        Return <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" onclick="sortTable('sharpe_ratio')">
                                        Sharpe <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" onclick="sortTable('win_rate')">
                                        Win Rate <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" onclick="sortTable('signal_accuracy')">
                                        Signal Acc. <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" onclick="sortTable('max_drawdown')">
                                        Max DD <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" onclick="sortTable('total_trades')">
                                        Trades <i class="fas fa-sort"></i>
                                    </th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="results-tbody">
                                <tr><td colspan="11" class="text-center text-muted">Select filters and click Apply to view results</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Distribution -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Return Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="return-distribution" height="250"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-scatter"></i> Risk-Return Scatter</h5>
                </div>
                <div class="card-body">
                    <div id="risk-return-scatter" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
let currentResults = [];
let currentTimestamp = null;
let allData = [];
let currentSortColumn = 'total_return';
let currentSortDirection = 'desc';

// Sort table by column
function sortTable(column) {
    // Toggle direction if clicking same column
    if (currentSortColumn === column) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortColumn = column;
        currentSortDirection = 'desc'; // Default to descending for new column
    }

    // Sort current results
    currentResults.sort((a, b) => {
        let aVal = a[column];
        let bVal = b[column];

        // Handle string comparisons
        if (typeof aVal === 'string') {
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
        }

        if (currentSortDirection === 'asc') {
            return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
        } else {
            return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
        }
    });

    // Update sort indicators
    updateSortIndicators();

    // Re-populate table
    populateResultsTable(currentResults);
}

function updateSortIndicators() {
    // Reset all sort icons
    document.querySelectorAll('.sortable i').forEach(icon => {
        icon.className = 'fas fa-sort';
    });

    // Find the active column header and update its icon
    document.querySelectorAll('.sortable').forEach(th => {
        const onclick = th.getAttribute('onclick');
        if (onclick && onclick.includes(`'${currentSortColumn}'`)) {
            const icon = th.querySelector('i');
            if (currentSortDirection === 'asc') {
                icon.className = 'fas fa-sort-up';
            } else {
                icon.className = 'fas fa-sort-down';
            }
        }
    });
}

// Load available backtest runs
async function loadAvailableRuns() {
    try {
        const response = await fetch('/api/runs');
        const runs = await response.json();

        const selector = document.getElementById('run-selector');
        selector.innerHTML = '';

        runs.forEach((run, index) => {
            const option = document.createElement('option');
            option.value = run.timestamp;
            option.textContent = `${run.datetime} ${run.has_json ? 'âœ“' : ''}`;
            if (index === 0) option.selected = true; // Select latest by default
            selector.appendChild(option);
        });

        if (runs.length > 0) {
            currentTimestamp = runs[0].timestamp;
            await loadRunData();
        }
    } catch (error) {
        console.error('Error loading runs:', error);
    }
}

// Load data for selected run
async function loadRunData() {
    const timestamp = document.getElementById('run-selector').value;
    currentTimestamp = timestamp;

    try {
        const response = await fetch(`/api/detailed/${timestamp}`);
        allData = await response.json();

        // Populate strategy dropdown
        const strategies = [...new Set(allData.map(d => d.strategy_name))].sort();
        const strategyFilter = document.getElementById('strategy-filter');
        strategyFilter.innerHTML = '<option value="">All Strategies</option>';
        strategies.forEach(strategy => {
            const option = document.createElement('option');
            option.value = strategy;
            option.textContent = strategy;
            strategyFilter.appendChild(option);
        });

        // Populate period dropdown
        const periods = [...new Set(allData.map(d => d.period_name))].sort();
        const periodFilter = document.getElementById('period-filter');
        periodFilter.innerHTML = '<option value="">All Periods</option>';
        periods.forEach(period => {
            const option = document.createElement('option');
            option.value = period;
            option.textContent = period;
            periodFilter.appendChild(option);
        });

        // Auto-apply filters to show data immediately
        applyFilters();
    } catch (error) {
        console.error('Error loading run data:', error);
    }
}

function selectUniverse(universeName) {
    document.getElementById('universe-filter').value = universeName;
    applyFilters();
}

function resetFilters() {
    document.getElementById('ticker-filter').value = '';
    document.getElementById('strategy-filter').value = '';
    document.getElementById('period-filter').value = '';
    document.getElementById('universe-filter').value = '';
    document.getElementById('sector-filter').value = '';
    document.getElementById('min-sharpe').value = '';
    document.getElementById('min-return').value = '';
    document.getElementById('min-winrate').value = '';

    applyFilters();
}

async function applyFilters() {
    if (!allData || allData.length === 0) {
        console.log('No data loaded yet');
        return;
    }

    // Get filter values
    const tickerInput = document.getElementById('ticker-filter').value.trim().toUpperCase();
    const specificTickers = tickerInput ? tickerInput.split(',').map(t => t.trim()) : [];
    const strategy = document.getElementById('strategy-filter').value;
    const period = document.getElementById('period-filter').value;
    const sector = document.getElementById('sector-filter').value;
    const minSharpe = parseFloat(document.getElementById('min-sharpe').value);
    const minReturn = parseFloat(document.getElementById('min-return').value);
    const minWinRate = parseFloat(document.getElementById('min-winrate').value);

    // Filter data
    let filtered = allData.filter(result => {
        // Specific ticker filter (highest priority)
        if (specificTickers.length > 0 && !specificTickers.includes(result.symbol)) {
            return false;
        }

        // Strategy filter
        if (strategy && result.strategy_name !== strategy) {
            return false;
        }

        // Period filter
        if (period && result.period_name !== period) {
            return false;
        }

        // Sector filter
        if (sector && result.sector !== sector) {
            return false;
        }

        // Min sharpe filter
        if (!isNaN(minSharpe) && result.sharpe_ratio < minSharpe) {
            return false;
        }

        // Min return filter (convert to decimal)
        if (!isNaN(minReturn) && result.total_return < minReturn) {
            return false;
        }

        // Min win rate filter
        if (!isNaN(minWinRate) && result.win_rate < minWinRate) {
            return false;
        }

        return true;
    });

    currentResults = filtered;

    // Update summary
    document.getElementById('results-count').textContent = filtered.length.toLocaleString();

    if (filtered.length > 0) {
        const avgReturn = filtered.reduce((sum, r) => sum + r.total_return, 0) / filtered.length;
        const avgSharpe = filtered.reduce((sum, r) => sum + r.sharpe_ratio, 0) / filtered.length;

        document.getElementById('avg-return').textContent = avgReturn.toFixed(2) + '%';
        document.getElementById('avg-sharpe').textContent = avgSharpe.toFixed(2);

        // Sort by current sort column and direction
        filtered.sort((a, b) => {
            let aVal = a[currentSortColumn];
            let bVal = b[currentSortColumn];

            if (typeof aVal === 'string') {
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
            }

            if (currentSortDirection === 'asc') {
                return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
            } else {
                return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
            }
        });

        // Update sort indicators
        updateSortIndicators();

        // Populate table
        populateResultsTable(filtered);

        // Create charts
        createReturnDistribution(filtered);
        createRiskReturnScatter(filtered);
    } else {
        document.getElementById('avg-return').textContent = 'N/A';
        document.getElementById('avg-sharpe').textContent = 'N/A';
        document.getElementById('results-tbody').innerHTML = '<tr><td colspan="11" class="text-center text-warning">No results match your filters</td></tr>';
    }
}

function populateResultsTable(results) {
    const tbody = document.getElementById('results-tbody');
    tbody.innerHTML = '';
    const timestamp = currentTimestamp;

    results.slice(0, 100).forEach(result => {
        const row = tbody.insertRow();

        row.innerHTML = `
            <td><strong>${result.strategy_name}</strong></td>
            <td><span class="badge bg-primary">${result.symbol}</span></td>
            <td>${result.sector || 'Unknown'}</td>
            <td>${result.period_name}</td>
            <td class="${result.total_return > 0 ? 'text-success' : 'text-danger'}">${(result.total_return * 100).toFixed(2)}%</td>
            <td>${result.sharpe_ratio.toFixed(2)}</td>
            <td>${result.win_rate.toFixed(1)}%</td>
            <td>${result.signal_accuracy.toFixed(1)}%</td>
            <td>${(result.max_drawdown * 100).toFixed(2)}%</td>
            <td>${result.total_trades}</td>
            <td>
                <a href="/candlestick/${timestamp}/${encodeURIComponent(result.strategy_name)}/${result.symbol}"
                   class="btn btn-sm btn-primary"
                   title="View candlestick chart">
                    <i class="fas fa-chart-line"></i>
                </a>
            </td>
        `;

        // Highlight excellent results
        if (result.sharpe_ratio > 2.0) {
            row.style.backgroundColor = '#e8f5e9';
        }
    });
}

function createReturnDistribution(results) {
    const returns = results.map(r => r.total_return * 100);

    // Create histogram bins
    const bins = 20;
    const min = Math.min(...returns);
    const max = Math.max(...returns);
    const binSize = (max - min) / bins;

    const histogram = new Array(bins).fill(0);
    const labels = [];

    for (let i = 0; i < bins; i++) {
        labels.push(`${(min + i * binSize).toFixed(1)}%`);
    }

    returns.forEach(ret => {
        const binIndex = Math.min(Math.floor((ret - min) / binSize), bins - 1);
        histogram[binIndex]++;
    });

    const ctx = document.getElementById('return-distribution').getContext('2d');

    if (window.returnDistChart) {
        window.returnDistChart.destroy();
    }

    window.returnDistChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Frequency',
                data: histogram,
                backgroundColor: 'rgba(75, 192, 192, 0.7)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Count' }
                },
                x: {
                    title: { display: true, text: 'Return (%)' }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
}

function createRiskReturnScatter(results) {
    const trace = {
        x: results.map(r => r.sharpe_ratio),
        y: results.map(r => r.total_return * 100),
        mode: 'markers',
        type: 'scatter',
        text: results.map(r => `${r.strategy_name} - ${r.symbol}`),
        marker: {
            size: 8,
            color: results.map(r => r.win_rate),
            colorscale: 'Viridis',
            showscale: true,
            colorbar: { title: 'Win Rate (%)' }
        }
    };

    const layout = {
        title: 'Risk-Return Profile',
        xaxis: { title: 'Sharpe Ratio' },
        yaxis: { title: 'Return (%)' },
        hovermode: 'closest',
        height: 300
    };

    Plotly.newPlot('risk-return-scatter', [trace], layout, {responsive: true});
}

// Load available runs and data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAvailableRuns();
});
</script>

<style>
.sortable {
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s;
}

.sortable:hover {
    background-color: rgba(0, 0, 0, 0.05);
}

.sortable i {
    margin-left: 5px;
    font-size: 0.8em;
    opacity: 0.6;
}

.sortable:hover i {
    opacity: 1;
}
</style>

{% endblock %}
